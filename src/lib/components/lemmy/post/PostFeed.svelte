<script lang="ts">
  import Post from "$lib/components/lemmy/post/Post.svelte";
  import Placeholder from "$lib/components/ui/Placeholder.svelte";
  import { userSettings } from "$lib/settings.js";
  import type { PostView } from "lemmy-js-client";
  import { Badge, Button } from "mono-svelte";
  import { ArchiveBox, Icon, Minus, Plus } from "svelte-hero-icons";
  import { expoOut } from "svelte/easing";
  import { fly, slide } from "svelte/transition";
  import InfiniteScroll from "svelte-infinite-scroll";
  import { loadPosts } from "$lib/lemmy";
  import { page } from "$app/stores";
  import { goto } from "$app/navigation";

  type PostViewWithCrossposts = PostView & {
    withCrossposts: true;
    crossposts: PostView[];
  };
  type PostViewWithoutCrossposts = PostView & { withCrossposts?: false };

  export let posts: PostView[];
  export let cursor: { next?: string; back?: string } | undefined = undefined;
  export let community;

  const addCrosspostProperty = (
    post: PostView,
    crossposts: PostView[],
  ): PostViewWithCrossposts => ({
    ...post,
    crossposts: crossposts,
    withCrossposts: true,
  });

  const combineCrossposts = (
    posts: PostView[],
  ): (PostViewWithCrossposts | PostViewWithoutCrossposts)[] => {
    const urlMap = new Map<
      string,
      PostViewWithCrossposts | PostViewWithoutCrossposts
    >();
    const results: (PostViewWithCrossposts | PostViewWithoutCrossposts)[] = [];
    const seenUrls = new Set<string>();

    posts.forEach((post) => {
      if (!post.post.url) {
        results.push(post);
        return;
      }

      let existing = urlMap.get(post.post.url);
      if (existing) {
        existing.withCrossposts = true;
        if (existing.withCrossposts) {
          existing.crossposts = [...(existing.crossposts || []), post];
        }

        urlMap.set(post.post.url, existing);
      } else {
        urlMap.set(post.post.url, post);
        results.push(post);
      }
      seenUrls.add(post.post.url);
    });

    return results;
  };

  $: combinedPosts = combineCrossposts(posts);

  let viewPost: number = -1;
</script>

<ul
  class="flex flex-col list-none {$userSettings.view == 'card'
    ? 'gap-3 md:gap-4'
    : 'divide-y'} divide-slate-200 dark:divide-zinc-800"
>
  {#if posts.length == 0}
    <div class="h-full grid place-items-center">
      <Placeholder
        icon={ArchiveBox}
        title="No posts"
        description="There are no posts that match this filter."
      >
        <Button href="/communities">
          <Icon src={Plus} size="16" mini slot="prefix" />
          <span>Follow some communities</span>
        </Button>
      </Placeholder>
    </div>
  {:else}
    {#each combinedPosts as post, index}
      {#if !($userSettings.hidePosts.deleted && post.post.deleted) && !($userSettings.hidePosts.removed && post.post.removed)}
        <li
          in:fly|global={{
            y: -8,
            duration: 500,
            opacity: 0,
            delay: index < 4 ? index * 100 : 0,
          }}
          class="relative"
        >
          <Post
            hideCommunity={community}
            view={$userSettings.view}
            {post}
            class="transition-all duration-250 {post.withCrossposts &&
            viewPost != post.post.id
              ? ''
              : ''}"
          >
            <button
              slot="badges"
              class:hidden={!post.withCrossposts}
              on:click={() => {
                if (viewPost == post.post.id) viewPost = -1;
                else viewPost = post.post.id;
              }}
            >
              {#if post.withCrossposts}
                <Badge
                  class="z-10 backdrop-blur-xl hover:brightness-110 cursor-pointer transition-all"
                  color="gray-subtle"
                >
                  {#if viewPost == post.post.id}
                    <Icon mini src={Minus} size="14" />
                  {:else}
                    <Icon mini src={Plus} size="14" />
                  {/if}
                  {post.crossposts.length} crosspost{post.crossposts.length == 1
                    ? ""
                    : "s"}
                </Badge>
              {/if}
            </button>
          </Post>
          {#if post.withCrossposts && viewPost == post.post.id}
            <div
              transition:slide|global={{
                axis: "y",
                duration: 500,
                easing: expoOut,
              }}
            >
              <span
                class="text-sm flex flex-row gap-2 items-center"
                class:my-4={$userSettings.view == "card"}
              >
                Crossposts <hr class="w-full dark:border-zinc-800" />
                {post.crossposts.length}
              </span>
              {#each post.crossposts as crosspost, index}
                <div class="w-full transition-all mb-4">
                  <Post post={crosspost} view={$userSettings.view} />
                </div>
              {/each}
            </div>
          {/if}
        </li>
      {/if}
    {/each}
  {/if}
  <InfiniteScroll
    window={true}
    threshold={100}
    on:loadMore={async () => {
      let newUrl = $page.url;
      newUrl.searchParams.set("cursor", cursor?.next || "");

      goto(newUrl, { invalidateAll: false, noScroll: true });

      let newPosts = await loadPosts(newUrl, fetch);
      posts = [...posts, ...newPosts.posts.posts];

      cursor = newPosts.cursor;
    }}
  />
</ul>
